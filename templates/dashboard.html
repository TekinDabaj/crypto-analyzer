<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Market Analyzer</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg-primary:#0a0a0f;--bg-secondary:#12121a;--bg-tertiary:#1a1a2e;--bg-card:#16162a;--border:#2d2d4a;--text-primary:#e8e8ff;--text-secondary:#8888aa;--green:#00d68f;--red:#ff4d6a;--yellow:#ffb800;--blue:#00b4ff;--purple:#8b5cf6;--orange:#ff9500}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh}

    /* Shimmer Animation */
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
    .shimmer{background:linear-gradient(90deg,var(--bg-tertiary) 25%,var(--bg-card) 50%,var(--bg-tertiary) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}
    .shimmer-text{height:14px;border-radius:4px;margin:4px 0}
    .shimmer-title{height:24px;width:60%;border-radius:6px}
    .shimmer-block{border-radius:8px}
    .shimmer-circle{border-radius:50%}

    .header{background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
    .logo{display:flex;align-items:center;gap:10px}
    .logo-icon{width:34px;height:34px;background:linear-gradient(135deg,#8b5cf6,#00b4ff);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold;color:white}
    .logo h1{font-size:15px;font-weight:700}
    .header-controls{display:flex;gap:12px;align-items:center}
    .header-stat{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg-tertiary);border-radius:6px;font-size:12px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    .btn{background:linear-gradient(135deg,#8b5cf6,#00b4ff);color:white;border:none;padding:8px 16px;border-radius:6px;font-weight:600;font-size:12px;cursor:pointer;transition:all 0.2s}
    .btn:hover{opacity:0.9;transform:translateY(-1px)}
    .btn-secondary{background:var(--bg-tertiary);border:1px solid var(--border)}
    .btn-icon{width:36px;height:36px;padding:0;display:flex;align-items:center;justify-content:center;font-size:18px}
    .user-menu{display:flex;align-items:center;gap:10px;padding:6px 12px;background:var(--bg-tertiary);border-radius:6px;cursor:pointer}
    .user-avatar{width:28px;height:28px;border-radius:50%;background:var(--purple)}
    .user-name{font-size:12px;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .dropdown{position:relative}
    .dropdown-menu{position:absolute;top:100%;right:0;margin-top:8px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;min-width:150px;display:none;z-index:200}
    .dropdown-menu.show{display:block}
    .dropdown-item{padding:10px 14px;font-size:13px;cursor:pointer;display:block;color:var(--text-primary);text-decoration:none}
    .dropdown-item:hover{background:var(--bg-tertiary)}
    .main{display:grid;grid-template-columns:220px 1fr;min-height:calc(100vh - 58px);transition:grid-template-columns 0.3s ease}
    .main.collapsed{grid-template-columns:0px 1fr}
    .sidebar{background:var(--bg-secondary);border-right:1px solid var(--border);padding:14px;overflow-y:auto;overflow-x:hidden;transition:all 0.3s ease;min-width:220px}
    .main.collapsed .sidebar{min-width:0;padding:0;border-right:none;opacity:0;pointer-events:none}
    .section-title{font-size:10px;text-transform:uppercase;color:var(--text-secondary);letter-spacing:1px;margin-bottom:10px;border-left:2px solid var(--purple);padding-left:8px;display:flex;justify-content:space-between;align-items:center}
    .sidebar-toggle{background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:14px;padding:2px 6px;border-radius:4px;transition:all 0.2s}
    .sidebar-toggle:hover{background:var(--bg-tertiary);color:var(--text-primary)}
    .expand-btn{position:fixed;left:0;top:50%;transform:translateY(-50%);background:var(--bg-secondary);border:1px solid var(--border);border-left:none;border-radius:0 6px 6px 0;padding:12px 6px;cursor:pointer;color:var(--text-secondary);z-index:50;opacity:0;pointer-events:none;transition:all 0.3s ease}
    .main.collapsed .expand-btn{opacity:1;pointer-events:auto}
    .expand-btn:hover{background:var(--bg-tertiary);color:var(--text-primary)}
    .stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:10px}
    .stat-label{font-size:10px;color:var(--text-secondary);text-transform:uppercase}
    .stat-value{font-size:20px;font-weight:700}
    .positive{color:var(--green)}.negative{color:var(--red)}.neutral{color:var(--yellow)}
    .weight-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:6px;font-size:12px}
    .weight-item label{color:var(--text-secondary);text-transform:uppercase;font-size:10px}
    .weight-item input{width:50px;background:var(--bg-card);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);padding:4px 6px;font-size:12px;text-align:center}
    .legend{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px}
    .legend-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-secondary);padding:5px 8px;background:var(--bg-tertiary);border-radius:4px}
    .grade-dot{width:8px;height:8px;border-radius:50%}
    .grade-a{background:var(--green)}.grade-b{background:var(--blue)}.grade-c{background:var(--yellow)}.grade-d{background:var(--red)}

    /* Market Regime Display */
    .regime-card{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:10px}
    .regime-card.bullish{border-color:var(--green);background:rgba(0,214,143,0.1)}
    .regime-card.bearish{border-color:var(--red);background:rgba(255,77,106,0.1)}
    .regime-card.neutral{border-color:var(--yellow);background:rgba(255,184,0,0.1)}
    .regime-name{font-size:13px;font-weight:600;margin-bottom:10px;color:var(--text-primary)}
    .regime-weights{display:flex;gap:8px;margin-bottom:10px}
    .regime-weight{flex:1;background:var(--bg-tertiary);border-radius:6px;padding:8px;text-align:center}
    .weight-label{display:block;font-size:9px;text-transform:uppercase;color:var(--text-secondary);margin-bottom:2px}
    .weight-value{display:block;font-size:16px;font-weight:700;color:var(--purple)}
    .regime-reasoning{font-size:11px;line-height:1.5;color:var(--text-secondary);border-top:1px solid var(--border);padding-top:10px}
    .btc-context{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:10px}
    .context-row{display:flex;justify-content:space-between;padding:6px 0;font-size:11px;border-bottom:1px solid var(--border)}
    .context-row:last-child{border-bottom:none}
    .context-row span:first-child{color:var(--text-secondary)}
    .context-row span:last-child{font-weight:600}
    .context-row .bullish{color:var(--green)}
    .context-row .bearish{color:var(--red)}
    .scoring-info{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:10px;color:var(--text-secondary);line-height:1.6}
    .scoring-info p{margin:4px 0}

    /* Warnings Display */
    .weights-used{font-size:10px;color:var(--text-secondary);margin-top:12px;padding-top:10px;border-top:1px solid var(--border);text-align:center}
    .warnings-section{margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
    .warnings-title{font-size:10px;text-transform:uppercase;color:var(--text-secondary);margin-bottom:8px}
    .warnings-list{display:flex;flex-direction:column;gap:6px}
    .warning-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;font-size:11px;border-left:3px solid var(--text-secondary)}
    .warning-item.bullish{background:rgba(0,214,143,0.1);border-left-color:var(--green)}
    .warning-item.bearish{background:rgba(255,77,106,0.1);border-left-color:var(--red)}
    .warning-item.extreme{font-weight:600}
    .warning-item.signal{background:rgba(139,92,246,0.1);border-left-color:var(--purple)}
    .warning-type{font-size:9px;padding:2px 6px;background:rgba(255,255,255,0.1);border-radius:4px;text-transform:uppercase;font-weight:600}
    .warning-msg{flex:1;color:var(--text-primary)}
    .warning-item.caution{background:rgba(255,184,0,0.1);border-left-color:var(--yellow)}

    /* Structure Status */
    .structure-status{margin-top:10px;padding:8px 12px;border-radius:6px;font-size:11px;font-weight:600;text-align:center}
    .structure-status.confirms{background:rgba(0,214,143,0.15);color:var(--green);border:1px solid rgba(0,214,143,0.3)}
    .structure-status.conflicts{background:rgba(255,184,0,0.15);color:var(--yellow);border:1px solid rgba(255,184,0,0.3)}
    .structure-status.breakout{background:rgba(0,214,143,0.2);color:var(--green);border:1px solid var(--green)}
    .structure-status.breakdown{background:rgba(255,77,106,0.2);color:var(--red);border:1px solid var(--red)}

    /* Alert UI */
    .alert-toggle{display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all 0.2s;font-size:12px;color:var(--text-secondary)}
    .alert-toggle:hover{border-color:var(--purple)}
    .alert-toggle.active{background:rgba(139,92,246,0.2);border-color:var(--purple);color:var(--purple)}
    .alert-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.2s}
    .alert-modal.show{opacity:1;visibility:visible}
    .alert-modal-content{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;width:90%;max-width:420px;max-height:90vh;overflow-y:auto}
    .alert-modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .alert-modal-header h3{margin:0;font-size:16px}
    .alert-modal-close{background:none;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer;padding:4px 8px;line-height:1}
    .alert-modal-close:hover{color:var(--text-primary)}
    .alert-modal-body{padding:20px}
    .alert-section{margin-bottom:24px}
    .alert-section:last-child{margin-bottom:0}
    .alert-section-title{font-size:11px;text-transform:uppercase;color:var(--text-secondary);margin-bottom:12px;font-weight:600;letter-spacing:0.5px}
    .link-status{padding:16px;background:var(--bg-tertiary);border-radius:8px;text-align:center}
    .link-status.linked{background:rgba(0,214,143,0.1);border:1px solid rgba(0,214,143,0.3)}
    .link-status.unlinked{background:rgba(255,184,0,0.1);border:1px solid rgba(255,184,0,0.3)}
    .link-code{font-family:monospace;font-size:28px;letter-spacing:4px;color:var(--purple);margin:16px 0}
    .link-instructions{font-size:12px;color:var(--text-secondary);line-height:1.6}
    .link-instructions ol{margin:12px 0;padding-left:20px}
    .link-instructions li{margin:6px 0}
    .link-instructions code{background:var(--bg-secondary);padding:2px 6px;border-radius:4px;color:var(--purple)}
    .alert-option{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--border)}
    .alert-option:last-child{border-bottom:none}
    .alert-option-info{flex:1;padding-right:16px}
    .alert-option-title{font-size:13px;margin-bottom:4px}
    .alert-option-desc{font-size:11px;color:var(--text-secondary)}
    .toggle-switch{position:relative;width:44px;height:24px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all 0.2s;flex-shrink:0}
    .toggle-switch.active{background:var(--purple);border-color:var(--purple)}
    .toggle-switch::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;background:white;border-radius:50%;transition:transform 0.2s}
    .toggle-switch.active::after{transform:translateX(20px)}
    .alert-btn{width:100%;padding:12px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;margin-top:8px;transition:all 0.2s}
    .alert-btn.primary{background:var(--purple);color:white}
    .alert-btn.primary:hover{background:#7c3aed}
    .alert-btn.secondary{background:var(--bg-tertiary);color:var(--text-secondary);border:1px solid var(--border)}
    .alert-btn.secondary:hover{border-color:var(--text-secondary)}
    .alert-btn.danger{background:rgba(255,77,106,0.2);color:var(--red);border:1px solid rgba(255,77,106,0.3)}
    .alert-btn.danger:hover{background:rgba(255,77,106,0.3)}
    .alert-btn:disabled{opacity:0.5;cursor:not-allowed}
    .content{padding:14px;overflow-y:auto;background:linear-gradient(180deg,#1a1a2e 0%,#0a0a0f 100%);min-height:calc(100vh - 58px)}

    /* List View */
    #list-view{transition:opacity 0.2s}
    .btc-section{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px;border-top:2px solid #f7931a}
    .btc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .btc-title{display:flex;align-items:center;gap:12px}
    .btc-icon{width:42px;height:42px;background:linear-gradient(135deg,#f7931a,#ff9500);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:white}
    .btc-name h2{font-size:18px}.btc-name span{font-size:11px;color:var(--text-secondary)}
    .btc-price{font-size:26px;font-weight:700;text-align:right}
    .btc-change{font-size:13px;text-align:right}
    .btc-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .btc-stat{background:var(--bg-tertiary);border-radius:6px;padding:10px;text-align:center}
    .btc-stat-label{font-size:9px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:4px}
    .btc-stat-value{font-size:13px;font-weight:600}
    .sentiment-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:10px;font-weight:600}
    .sentiment-bullish{background:rgba(0,214,143,0.2);color:var(--green);border:1px solid var(--green)}
    .sentiment-bearish{background:rgba(255,77,106,0.2);color:var(--red);border:1px solid var(--red)}
    .sentiment-neutral{background:rgba(255,184,0,0.2);color:var(--yellow);border:1px solid var(--yellow)}

    /* Momentum Insight Box */
    .momentum-box{margin-top:12px;margin-bottom:20px;padding:12px 16px;background:var(--bg-tertiary);border-radius:8px;border-left:3px solid var(--purple);position:relative}
    .momentum-box.bullish{border-left-color:var(--green);background:rgba(0,214,143,0.08)}
    .momentum-box.bearish{border-left-color:var(--red);background:rgba(255,77,106,0.08)}
    .momentum-box.caution{border-left-color:var(--yellow);background:rgba(255,184,0,0.08)}
    .momentum-box.neutral{border-left-color:var(--text-secondary);background:rgba(136,136,170,0.08)}
    .momentum-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .momentum-icon{font-size:14px}
    .momentum-label{font-size:10px;text-transform:uppercase;color:var(--text-secondary);letter-spacing:0.5px}
    .momentum-confidence{font-size:9px;padding:2px 6px;border-radius:10px;background:rgba(255,255,255,0.1);color:var(--text-secondary);margin-left:auto}
    .momentum-confidence.high{background:rgba(0,214,143,0.2);color:var(--green)}
    .momentum-confidence.medium{background:rgba(255,184,0,0.2);color:var(--yellow)}
    .momentum-confidence.low{background:rgba(136,136,170,0.2);color:var(--text-secondary)}
    .momentum-text{font-size:13px;line-height:1.5;color:var(--text-primary)}
    .momentum-bias{display:flex;gap:12px;margin-top:8px;font-size:10px;color:var(--text-secondary)}
    .momentum-bias span{display:flex;align-items:center;gap:4px}
    .bias-dot{width:6px;height:6px;border-radius:50%}
    .bias-dot.bullish{background:var(--green)}
    .bias-dot.bearish{background:var(--red)}
    .bias-dot.neutral{background:var(--text-secondary)}

    /* Compact momentum for table rows */
    .momentum-compact{padding:10px 14px;background:var(--bg-tertiary);border-radius:6px;border-left:3px solid var(--purple);font-size:12px;line-height:1.4;color:var(--text-secondary)}
    .momentum-compact.bullish{border-left-color:var(--green);color:#7fffd4;background:rgba(0,214,143,0.06)}
    .momentum-compact.bearish{border-left-color:var(--red);color:#ffb3be;background:rgba(255,77,106,0.06)}
    .momentum-compact.caution{border-left-color:var(--yellow);color:#ffe066;background:rgba(255,184,0,0.06)}
    .momentum-compact.neutral{border-left-color:var(--text-secondary);background:rgba(136,136,170,0.06)}
    .momentum-row{border-top:none!important}
    .momentum-row td{padding:0 14px 14px 14px!important;border-top:none!important}
    .momentum-row:hover{background:transparent!important}
    .coins-table tbody tr:not(.momentum-row):hover+.momentum-row{background:rgba(139,92,246,0.08)}
    .table-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
    .search-box{display:flex;align-items:center;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:6px;padding:0 12px}
    .search-box input{background:transparent;border:none;color:var(--text-primary);padding:10px;font-size:13px;width:180px;outline:none}
    .filter-tabs{display:flex;gap:6px;flex-wrap:wrap}
    .filter-tab{padding:8px 14px;border-radius:6px;font-size:12px;border:1px solid var(--border);background:var(--bg-tertiary);color:var(--text-secondary);cursor:pointer;transition:all 0.2s}
    .filter-tab.active{background:linear-gradient(135deg,#8b5cf6,#00b4ff);color:white;border-color:transparent}
    .coins-table{width:100%;border-collapse:collapse;background:var(--bg-card);border-radius:8px;overflow:hidden;border:1px solid var(--border)}
    .coins-table thead{background:var(--bg-tertiary)}
    .coins-table th{text-align:left;padding:12px 14px;font-size:11px;text-transform:uppercase;color:var(--text-secondary);font-weight:600}
    .coins-table tbody tr{border-top:1px solid var(--border);cursor:pointer;transition:background 0.2s}
    .coins-table tbody tr:hover{background:rgba(139,92,246,0.08)}
    .coins-table td{padding:12px 14px;font-size:13px}
    .coin-cell{display:flex;align-items:center;gap:10px}
    .coin-icon{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#4a3f8a,#2d2d6a);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:11px}
    .coin-name{font-weight:600;font-size:14px}
    .coin-pair{font-size:10px;color:var(--text-secondary)}
    .obv-cell{display:flex;flex-direction:column;gap:2px}
    .obv-trend{font-weight:600;font-size:12px}
    .obv-detail{font-size:10px;color:var(--text-secondary)}
    .score-badge{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:6px;font-weight:700;font-size:12px}
    .score-a{background:rgba(0,214,143,0.2);border:1px solid var(--green);color:var(--green)}
    .score-b{background:rgba(0,180,255,0.2);border:1px solid var(--blue);color:var(--blue)}
    .score-c{background:rgba(255,184,0,0.2);border:1px solid var(--yellow);color:var(--yellow)}
    .score-d{background:rgba(255,77,106,0.2);border:1px solid var(--red);color:var(--red)}
    .signals-cell{display:flex;flex-wrap:wrap;gap:4px;max-width:280px}
    .signal-tag{display:inline-block;padding:3px 8px;border-radius:4px;font-size:10px;background:var(--bg-tertiary);border:1px solid var(--border);color:#fff}
    .signal-tag.obv{border-color:var(--purple);background:rgba(139,92,246,0.2)}
    .signal-tag.vol{border-color:var(--blue);background:rgba(0,180,255,0.2)}
    .signal-tag.rsi{border-color:var(--yellow);background:rgba(255,184,0,0.2)}
    .signal-tag.trend{border-color:var(--green);background:rgba(0,214,143,0.2)}
    .signal-tag.macd{border-color:#ff69b4;background:rgba(255,105,180,0.2)}
    .signal-tag.fund{border-color:var(--red);background:rgba(255,77,106,0.2)}
    .remove-btn{background:var(--red);color:white;border:none;padding:4px 8px;border-radius:4px;font-size:10px;cursor:pointer;opacity:0;transition:opacity 0.2s}
    tr:hover .remove-btn{opacity:1}

    /* Detail View */
    #detail-view{display:none}
    #detail-view.active{display:block}
    #list-view.hidden{display:none}

    .detail-header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
    .back-btn{width:40px;height:40px;border-radius:10px;background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all 0.2s}
    .back-btn:hover{background:var(--bg-tertiary);border-color:var(--purple)}
    .detail-title{display:flex;align-items:center;gap:14px;flex:1}
    .detail-icon{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#4a3f8a,#2d2d6a);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px}
    .detail-name h2{font-size:22px;margin-bottom:2px}
    .detail-name span{font-size:12px;color:var(--text-secondary)}
    .detail-price{text-align:right}
    .detail-price-value{font-size:28px;font-weight:700}
    .detail-price-change{font-size:14px}

    .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
    .detail-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px}
    .detail-card-title{font-size:11px;text-transform:uppercase;color:var(--text-secondary);letter-spacing:0.5px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
    .detail-card-title::before{content:'';width:3px;height:12px;background:var(--purple);border-radius:2px}

    /* Pie Chart */
    .chart-container{display:flex;align-items:center;gap:24px}
    .pie-chart{width:120px;height:120px;border-radius:50%;position:relative;flex-shrink:0}
    .pie-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:70px;height:70px;background:var(--bg-card);border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .pie-center-value{font-size:16px;font-weight:700}
    .pie-center-label{font-size:9px;color:var(--text-secondary);text-transform:uppercase}
    .chart-legend{flex:1}
    .legend-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
    .legend-row:last-child{border-bottom:none}
    .legend-color{width:12px;height:12px;border-radius:3px;flex-shrink:0}
    .legend-label{font-size:12px;color:var(--text-secondary);flex:1}
    .legend-value{font-size:13px;font-weight:600}
    .legend-pct{font-size:11px;color:var(--text-secondary);width:40px;text-align:right}

    /* Score Breakdown */
    .score-breakdown{display:grid;gap:12px}
    .score-row{display:flex;align-items:center;gap:12px}
    .score-label{width:70px;font-size:11px;color:var(--text-secondary);text-transform:uppercase}
    .score-bar-container{flex:1;height:8px;background:var(--bg-tertiary);border-radius:4px;overflow:hidden}
    .score-bar{height:100%;border-radius:4px;transition:width 0.5s ease}
    .score-value{width:40px;font-size:12px;font-weight:600;text-align:right}

    /* Indicator Cards */
    .indicator-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
    .indicator-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center}
    .indicator-label{font-size:10px;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px}
    .indicator-value{font-size:18px;font-weight:700}
    .indicator-sub{font-size:11px;color:var(--text-secondary);margin-top:4px}

    /* Signals Section */
    .signals-section{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px}
    .signals-grid{display:flex;flex-wrap:wrap;gap:8px}
    .signal-chip{padding:8px 14px;border-radius:6px;font-size:12px;font-weight:500}

    /* Levels/Entry Targets Section */
    .levels-section{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px}
    .levels-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .levels-column h4{font-size:12px;text-transform:uppercase;color:var(--text-secondary);margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .levels-column h4::before{content:'';width:8px;height:8px;border-radius:2px}
    .levels-column.support h4::before{background:var(--green)}
    .levels-column.resistance h4::before{background:var(--red)}
    .level-item{display:flex;align-items:center;gap:12px;padding:10px 12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:8px;border-left:3px solid transparent}
    .level-item.support{border-left-color:var(--green)}
    .level-item.resistance{border-left-color:var(--red)}
    .level-item.poc{border-left-color:var(--purple);background:rgba(139,92,246,0.1)}
    .level-item.sma{border-left-color:var(--blue);background:rgba(0,180,255,0.1)}
    .level-price{font-size:14px;font-weight:600;flex:1}
    .level-meta{text-align:right}
    .level-distance{font-size:12px;font-weight:600}
    .level-strength{font-size:10px;color:var(--text-secondary)}
    .level-badge{display:inline-block;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:600;margin-left:6px}
    .level-badge.hvn{background:rgba(139,92,246,0.3);color:var(--purple)}
    .level-badge.poc{background:rgba(255,184,0,0.3);color:var(--yellow)}
    .strength-bar{width:60px;height:4px;background:var(--bg-primary);border-radius:2px;overflow:hidden;margin-top:4px}
    .strength-fill{height:100%;border-radius:2px}
    .no-levels{color:var(--text-secondary);font-size:12px;padding:10px;text-align:center}

    /* History Section */
    .history-section{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .history-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .history-header h3{font-size:14px}
    .history-table{width:100%;border-collapse:collapse}
    .history-table th{text-align:left;padding:12px 20px;font-size:10px;text-transform:uppercase;color:var(--text-secondary);background:var(--bg-tertiary);font-weight:600}
    .history-table td{padding:14px 20px;font-size:13px;border-top:1px solid var(--border)}
    .history-table tr:hover{background:rgba(139,92,246,0.05)}
    .history-grade{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:4px;font-weight:700;font-size:11px}
    .today-badge{display:inline-block;padding:2px 6px;background:var(--purple);color:white;border-radius:4px;font-size:9px;margin-left:6px}
    .load-more-container{padding:16px;text-align:center;border-top:1px solid var(--border)}
    .no-history{text-align:center;padding:40px;color:var(--text-secondary)}

    /* Shimmer variants for detail view */
    .detail-shimmer-header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
    .detail-shimmer-icon{width:48px;height:48px}
    .detail-shimmer-info{flex:1}
    .detail-shimmer-price{width:150px;height:40px}

    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,10,15,0.9);z-index:200;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-content{background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;width:90%;max-width:500px;max-height:85vh;display:flex;flex-direction:column}
    .modal-header{padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-header h2{font-size:18px}
    .modal-close{width:30px;height:30px;border-radius:6px;background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-secondary);cursor:pointer;font-size:18px}
    .modal-body{padding:16px;overflow-y:auto;flex:1}
    .add-coin-section{margin-bottom:20px;padding:14px;background:var(--bg-tertiary);border-radius:8px}
    .add-coin-section h3{font-size:12px;margin-bottom:10px;color:var(--text-secondary)}
    .add-coin-grid{display:flex;flex-wrap:wrap;gap:6px;max-height:200px;overflow-y:auto}
    .add-coin-btn{padding:6px 12px;border-radius:4px;font-size:11px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);cursor:pointer;transition:all 0.2s}
    .add-coin-btn:hover{border-color:var(--purple);background:rgba(139,92,246,0.2)}
    .add-coin-btn.added{border-color:var(--green);background:rgba(0,214,143,0.2)}

    .loading,.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:50px;color:var(--text-secondary)}
    .spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:14px}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media(max-width:1000px){.btc-grid{grid-template-columns:repeat(3,1fr)}.detail-grid{grid-template-columns:1fr}.indicator-grid{grid-template-columns:repeat(2,1fr)}.levels-grid{grid-template-columns:1fr}}
    @media(max-width:800px){.main{grid-template-columns:1fr}.sidebar{display:none}.indicator-grid{grid-template-columns:repeat(2,1fr)}.levels-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="header">
    <div class="logo"><div class="logo-icon">CA</div><h1>CRYPTO ANALYZER</h1></div>
    <div class="header-controls">
      <div class="header-stat"><div class="status-dot"></div><span id="status-text">Live</span></div>
      <div class="header-stat"><span>Scans:</span><strong id="scan-count">0</strong></div>
      <div class="header-stat"><span>Updated:</span><strong id="last-scan">--:--</strong></div>
      <div class="dropdown">
        <div class="user-menu" onclick="toggleDropdown()">
          <img class="user-avatar" id="user-avatar" src="" alt="">
          <span class="user-name" id="user-name">User</span>
        </div>
        <div class="dropdown-menu" id="user-dropdown">
          <a href="/auth/logout" class="dropdown-item">Logout</a>
        </div>
      </div>
    </div>
  </header>
  <main class="main" id="main-container">
    <button class="expand-btn" onclick="toggleSidebar()" title="Expand sidebar">‚Ä∫</button>
    <aside class="sidebar" id="sidebar">
      <div class="section-title"><span>Overview</span><button class="sidebar-toggle" onclick="toggleSidebar()" title="Collapse sidebar">‚Äπ</button></div>
      <div class="stat-card"><div class="stat-label">Your Coins</div><div class="stat-value" id="coins-count">--</div></div>
      <div class="stat-card"><div class="stat-label">High Score (A/B)</div><div class="stat-value positive" id="high-score-count">--</div></div>
      <div class="stat-card"><div class="stat-label">Avg Score</div><div class="stat-value" id="avg-score">--</div></div>
      <div class="section-title" style="margin-top:16px">Market Regime</div>
      <div class="regime-card" id="regime-card">
        <div class="regime-name" id="regime-name">Detecting...</div>
        <div class="regime-weights">
          <div class="regime-weight"><span class="weight-label">OBV</span><span class="weight-value" id="weight-obv">--</span></div>
          <div class="regime-weight"><span class="weight-label">Volume</span><span class="weight-value" id="weight-volume">--</span></div>
        </div>
        <div class="regime-reasoning" id="regime-reasoning">Analyzing BTC to determine market conditions...</div>
      </div>
      <div class="section-title" style="margin-top:16px">BTC Context</div>
      <div class="btc-context">
        <div class="context-row"><span>Trend (1h)</span><span id="ctx-trend-1h">--</span></div>
        <div class="context-row"><span>Trend (4h)</span><span id="ctx-trend-4h">--</span></div>
        <div class="context-row"><span>OBV Flow</span><span id="ctx-obv">--</span></div>
        <div class="context-row"><span>ATR %</span><span id="ctx-atr">--</span></div>
        <div class="context-row"><span>Vol Ratio</span><span id="ctx-vol">--</span></div>
      </div>
      <div class="section-title" style="margin-top:16px">Grades</div>
      <div class="legend">
        <div class="legend-item"><div class="grade-dot grade-a"></div>A: 80+</div>
        <div class="legend-item"><div class="grade-dot grade-b"></div>B: 70-79</div>
        <div class="legend-item"><div class="grade-dot grade-c"></div>C: 60-69</div>
        <div class="legend-item"><div class="grade-dot grade-d"></div>D/F: <60</div>
      </div>
      <div class="section-title" style="margin-top:16px">Scoring Logic</div>
      <div class="scoring-info">
        <p>Score = OBV + Volume only</p>
        <p>RSI & Funding = Warning flags</p>
        <p>Weights adjust dynamically based on BTC market regime</p>
      </div>
    </aside>
    <section class="content">
      <!-- List View -->
      <div id="list-view">
        <div class="btc-section">
          <div class="btc-header">
            <div class="btc-title"><div class="btc-icon">B</div><div class="btc-name"><h2>Bitcoin</h2><span>BTC/USDT - Market Leader</span></div></div>
            <div><div class="btc-price" id="btc-price">$--,---</div><div class="btc-change" id="btc-change">--%</div></div>
          </div>
          <div class="btc-grid">
            <div class="btc-stat"><div class="btc-stat-label">Sentiment</div><div class="btc-stat-value"><span class="sentiment-badge sentiment-neutral" id="btc-sentiment">--</span></div></div>
            <div class="btc-stat"><div class="btc-stat-label">Trend</div><div class="btc-stat-value" id="btc-trend">--</div></div>
            <div class="btc-stat"><div class="btc-stat-label">Spot Vol</div><div class="btc-stat-value" id="btc-spot-vol">--</div></div>
            <div class="btc-stat"><div class="btc-stat-label">Futures Vol</div><div class="btc-stat-value" id="btc-volume">--</div></div>
            <div class="btc-stat"><div class="btc-stat-label">OBV</div><div class="btc-stat-value" id="btc-obv">--</div></div>
            <div class="btc-stat"><div class="btc-stat-label">Funding</div><div class="btc-stat-value" id="btc-funding">--</div></div>
          </div>
          <div class="momentum-box neutral" id="btc-momentum">
            <div class="momentum-header">
              <span class="momentum-icon">üìä</span>
              <span class="momentum-label">Trend Insight</span>
              <span class="momentum-confidence" id="btc-momentum-confidence">--</span>
            </div>
            <div class="momentum-text" id="btc-momentum-text">Loading momentum analysis...</div>
            <div class="momentum-bias">
              <span><span class="bias-dot neutral" id="btc-ltf-dot"></span>Short-term: <strong id="btc-ltf-bias">--</strong></span>
              <span><span class="bias-dot neutral" id="btc-htf-dot"></span>Macro: <strong id="btc-htf-bias">--</strong></span>
            </div>
          </div>
        </div>
        <div class="table-controls">
          <div style="display:flex;gap:10px;align-items:center">
            <div class="search-box"><span>üîç</span><input type="text" id="search-input" placeholder="Search..." oninput="applyFilters()"></div>
            <div class="alert-toggle" id="alert-toggle" onclick="openAlertModal()">
              <span>üîî</span>
              <span>Alerts</span>
            </div>
          </div>
          <div class="filter-tabs">
            <button class="filter-tab active" onclick="setFilter('all',this)">All</button>
            <button class="filter-tab" onclick="setFilter('high',this)">High Score</button>
            <button class="filter-tab" onclick="setFilter('bullish',this)">Bullish OBV</button>
            <button class="filter-tab" onclick="setFilter('volume',this)">High Volume</button>
            <button class="filter-tab" onclick="setFilter('divergence',this)">Divergence</button>
          </div>
        </div>
        <div id="table-container"><div class="loading"><div class="spinner"></div>Loading...</div></div>
      </div>

      <!-- Detail View -->
      <div id="detail-view"></div>
    </section>
  </main>

  <div class="modal" id="add-coin-modal">
    <div class="modal-content">
      <div class="modal-header"><h2>Manage Watchlist</h2><button class="modal-close" onclick="closeAddCoinModal()">√ó</button></div>
      <div class="modal-body" id="add-coin-body"><div class="loading"><div class="spinner"></div>Loading...</div></div>
    </div>
  </div>

<script>
let allCoins=[],userCoins=[],allAvailable=[],btcData=null,currentFilter="all",ws;
let detailState={symbol:null,coin:null,cursor:null,loading:false,history:[],historyLoaded:false};

document.addEventListener("DOMContentLoaded",()=>{loadUser();initWS();fetchData();setInterval(fetchData,30000)});

async function loadUser(){
  try{
    const r=await(await fetch("/api/me")).json();
    if(r.authenticated){
      document.getElementById("user-name").textContent=r.user.name||r.user.email;
      if(r.user.picture)document.getElementById("user-avatar").src=r.user.picture;
      userCoins=r.coins||[];
    }
  }catch(e){console.error(e)}
}

function initWS(){
  const p=location.protocol==="https:"?"wss:":"ws:";
  ws=new WebSocket(p+"//"+location.host+"/ws");
  ws.onopen=()=>document.getElementById("status-text").textContent="Live";
  ws.onmessage=e=>{if(JSON.parse(e.data).type==="scan_complete"){fetchData();if(detailState.symbol)refreshDetailData()}};
  ws.onclose=()=>{document.getElementById("status-text").textContent="Reconnecting...";setTimeout(initWS,3000)};
}

async function fetchData(){
  try{
    const d=await(await fetch("/api/scan")).json();
    allCoins=d.results||[];userCoins=d.user_coins||[];btcData=allCoins.find(c=>c.display_name==="BTC");

    // Update regime display
    if(d.regime){
      updateRegimeDisplay(d.regime);
    }

    document.getElementById("scan-count").textContent=d.scan_count||0;
    document.getElementById("last-scan").textContent=d.last_scan?new Date(d.last_scan).toLocaleTimeString():"--:--";
    document.getElementById("coins-count").textContent=allCoins.length;
    document.getElementById("high-score-count").textContent=allCoins.filter(c=>c.score.percentage>=70).length;
    document.getElementById("avg-score").textContent=allCoins.length?Math.round(allCoins.reduce((s,c)=>s+c.score.percentage,0)/allCoins.length)+"%":"--";
    updateBTC();
    if(!detailState.symbol)applyFilters();
  }catch(e){console.error(e)}
}

function updateRegimeDisplay(regime){
  // Update regime card
  const card=document.getElementById("regime-card");
  const trend=regime.trend||'neutral';
  card.className="regime-card "+(trend.includes('up')?'bullish':trend.includes('down')?'bearish':'neutral');

  document.getElementById("regime-name").textContent=regime.regime_name||'Unknown';
  document.getElementById("weight-obv").textContent=(regime.weights?.obv||50)+"%";
  document.getElementById("weight-volume").textContent=(regime.weights?.volume||50)+"%";
  document.getElementById("regime-reasoning").textContent=regime.reasoning||'Analyzing...';

  // Update BTC context
  const t1=regime.btc_trend_1h||'--';
  const t4=regime.btc_trend_4h||'--';
  const obv=regime.btc_obv||'--';

  const t1El=document.getElementById("ctx-trend-1h");
  t1El.textContent=t1.toUpperCase();
  t1El.className=t1==='uptrend'?'bullish':t1==='downtrend'?'bearish':'';

  const t4El=document.getElementById("ctx-trend-4h");
  t4El.textContent=t4.toUpperCase();
  t4El.className=t4==='uptrend'?'bullish':t4==='downtrend'?'bearish':'';

  const obvEl=document.getElementById("ctx-obv");
  obvEl.textContent=obv.toUpperCase();
  obvEl.className=obv==='bullish'?'bullish':obv==='bearish'?'bearish':'';

  document.getElementById("ctx-atr").textContent=(regime.btc_atr_pct||'--')+'%';
  document.getElementById("ctx-vol").textContent=regime.btc_vol_ratio||'--';
}

function updateBTC(){
  if(!btcData)return;
  const i=btcData.indicators["1h"];
  document.getElementById("btc-price").textContent="$"+btcData.price.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});
  const ce=document.getElementById("btc-change");
  ce.textContent=(btcData.price_change_24h>0?"+":"")+btcData.price_change_24h+"% (24h)";
  ce.className="btc-change "+(btcData.price_change_24h>=0?"positive":"negative");
  const bulls=(i.obv_trend==="bullish"?1:0)+(i.macd_bullish?1:0)+(i.trend==="uptrend"?1:0);
  const se=document.getElementById("btc-sentiment");
  if(bulls>=2){se.textContent="BULLISH";se.className="sentiment-badge sentiment-bullish"}
  else if(bulls===0){se.textContent="BEARISH";se.className="sentiment-badge sentiment-bearish"}
  else{se.textContent="NEUTRAL";se.className="sentiment-badge sentiment-neutral"}
  const te=document.getElementById("btc-trend");te.textContent=i.trend.toUpperCase();te.className="btc-stat-value "+(i.trend==="uptrend"?"positive":i.trend==="downtrend"?"negative":"");
  document.getElementById("btc-volume").innerHTML="$"+fmtVol(btcData.futures_volume);
  document.getElementById("btc-spot-vol").innerHTML="$"+fmtVol(btcData.spot_volume);
  document.getElementById("btc-obv").textContent=i.obv_trend.toUpperCase();
  document.getElementById("btc-obv").className="btc-stat-value "+(i.obv_trend==="bullish"?"positive":i.obv_trend==="bearish"?"negative":"");
  document.getElementById("btc-funding").textContent=btcData.funding_rate.toFixed(3)+"%";

  // Update BTC momentum insight
  if(btcData.momentum){
    const m=btcData.momentum;
    const mBox=document.getElementById("btc-momentum");
    mBox.className="momentum-box "+m.sentiment;
    document.getElementById("btc-momentum-text").textContent=m.text;
    const confEl=document.getElementById("btc-momentum-confidence");
    confEl.textContent=m.confidence.toUpperCase();
    confEl.className="momentum-confidence "+m.confidence;
    document.getElementById("btc-ltf-bias").textContent=m.ltf_bias.toUpperCase();
    document.getElementById("btc-htf-bias").textContent=m.htf_bias.toUpperCase();
    document.getElementById("btc-ltf-dot").className="bias-dot "+m.ltf_bias;
    document.getElementById("btc-htf-dot").className="bias-dot "+m.htf_bias;
  }
}


async function triggerScan(){document.getElementById("status-text").textContent="Scanning...";await fetch("/api/scan/trigger",{method:"POST"})}

function setFilter(f,btn){currentFilter=f;document.querySelectorAll(".filter-tab").forEach(t=>t.classList.remove("active"));btn&&btn.classList.add("active");applyFilters()}

function applyFilters(){
  const s=document.getElementById("search-input").value.toLowerCase();
  let coins=allCoins.filter(c=>c.display_name!=="BTC");
  if(s)coins=coins.filter(c=>c.display_name.toLowerCase().includes(s));
  if(currentFilter==="high")coins=coins.filter(c=>c.score.percentage>=70);
  if(currentFilter==="bullish")coins=coins.filter(c=>c.indicators["1h"].obv_trend==="bullish");
  if(currentFilter==="volume")coins=coins.filter(c=>c.indicators["1h"].volume_ratio>=1.3);
  if(currentFilter==="divergence")coins=coins.filter(c=>c.indicators["1h"].obv_divergence!=="none");
  renderTable(coins);
}

function renderTable(coins){
  const el=document.getElementById("table-container");
  if(!coins.length){el.innerHTML='<div class="empty-state">No coins match criteria</div>';return}
  el.innerHTML='<table class="coins-table"><thead><tr><th>Coin</th><th>Price</th><th>24h</th><th>OBV</th><th>Funding</th><th>Score</th><th>Signals</th><th style="text-align:right"><button class="btn btn-secondary" onclick="event.stopPropagation();openAddCoinModal()">+ Add Coins</button></th></tr></thead><tbody>'+
    coins.map(c=>{
      const i=c.indicators["1h"];
      const oc=i.obv_trend==="bullish"?"positive":i.obv_trend==="bearish"?"negative":"";
      const m=c.momentum||{text:'Analyzing...',sentiment:'neutral',confidence:'low'};
      return '<tr onclick="showDetail(\''+c.symbol+'\')"><td><div class="coin-cell"><div class="coin-icon">'+c.display_name.slice(0,2)+'</div><div><div class="coin-name">'+c.display_name+'</div><div class="coin-pair">USDT</div></div></div></td>'+
        '<td>$'+fmtPrice(c.price)+'</td><td class="'+(c.price_change_24h>=0?"positive":"negative")+'">'+(c.price_change_24h>0?"+":"")+c.price_change_24h+'%</td>'+
        '<td><div class="obv-cell"><span class="obv-trend '+oc+'">'+i.obv_trend.toUpperCase()+'</span><span class="obv-detail">'+(i.obv_change>0?"+":"")+i.obv_change.toFixed(1)+'%</span></div></td>'+
        '<td>'+c.funding_rate.toFixed(3)+'%</td><td><span class="score-badge '+scoreClass(c.score.grade)+'">'+c.score.grade+'</span></td>'+
        '<td><div class="signals-cell">'+c.signals.slice(0,3).map(s=>'<span class="signal-tag '+sigClass(s)+'">'+s+'</span>').join("")+'</div></td>'+
        '<td><button class="remove-btn" onclick="event.stopPropagation();removeCoin(\''+c.symbol+'\')">Remove</button></td></tr>'+
        '<tr onclick="showDetail(\''+c.symbol+'\')" class="momentum-row"><td colspan="8"><div class="momentum-compact '+m.sentiment+'">'+m.text+'</div></td></tr>'
    }).join("")+'</tbody></table>';
}

function scoreClass(g){return g.startsWith("A")?"score-a":g==="B"?"score-b":g==="C"?"score-c":"score-d"}
function sigClass(s){return s.includes("[OBV]")?"obv":s.includes("[VOL]")?"vol":s.includes("[RSI]")?"rsi":s.includes("[TREND]")?"trend":s.includes("[MACD]")?"macd":s.includes("[FUND]")?"fund":""}
function fmtPrice(p){return p>=1000?p.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}):p>=1?p.toFixed(4):p.toFixed(6)}
function fmtVol(v){return !v?"0":v>=1e9?(v/1e9).toFixed(2)+"B":v>=1e6?(v/1e6).toFixed(2)+"M":v>=1e3?(v/1e3).toFixed(1)+"K":v.toFixed(0)}
function fmtDate(d){return new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}
function getScoreColor(score){return score>=80?'var(--green)':score>=70?'var(--blue)':score>=60?'var(--yellow)':'var(--red)'}
function getStrengthColor(s){return s>=70?'var(--green)':s>=40?'var(--yellow)':'var(--red)'}

function renderLevelsSection(coin){
  const levels=coin.levels;
  if(!levels)return '<div class="levels-section"><div class="detail-card-title">Entry Targets</div><div class="no-levels">No level data available</div></div>';

  const supports=levels.supports||[];
  const resistances=levels.resistances||[];
  const poc=levels.poc;
  const dynamic=levels.dynamic_levels||[];

  // Render support item
  function renderLevelItem(level,type){
    const isSupport=type==='support';
    const color=isSupport?'var(--green)':'var(--red)';
    const badges=[];
    if(level.hvn)badges.push('<span class="level-badge hvn">HVN</span>');
    if(level.touches>1)badges.push(`<span class="level-badge" style="background:rgba(255,255,255,0.1);color:var(--text-secondary)">${level.touches}x</span>`);

    return `
      <div class="level-item ${type}">
        <div class="level-price">$${fmtPrice(level.price)}${badges.join('')}</div>
        <div class="level-meta">
          <div class="level-distance ${isSupport?'positive':'negative'}">${isSupport?'-':'+'}${level.distance_pct}%</div>
          <div class="strength-bar"><div class="strength-fill" style="width:${level.strength}%;background:${getStrengthColor(level.strength)}"></div></div>
          <div class="level-strength">${level.strength>=70?'Strong':level.strength>=40?'Moderate':'Weak'}</div>
        </div>
      </div>
    `;
  }

  // Render POC
  function renderPOC(){
    if(!poc)return '';
    return `
      <div class="level-item poc">
        <div class="level-price">$${fmtPrice(poc.price)}<span class="level-badge poc">POC</span></div>
        <div class="level-meta">
          <div class="level-distance">${poc.distance_pct}% away</div>
          <div class="level-strength">Point of Control</div>
        </div>
      </div>
    `;
  }

  // Render dynamic levels (SMAs)
  function renderDynamic(d){
    return `
      <div class="level-item sma">
        <div class="level-price">$${fmtPrice(d.price)}<span class="level-badge" style="background:rgba(0,180,255,0.3);color:var(--blue)">${d.label}</span></div>
        <div class="level-meta">
          <div class="level-strength">${d.is_support?'Dynamic Support':'Dynamic Resistance'}</div>
        </div>
      </div>
    `;
  }

  const supportDynamic=dynamic.filter(d=>d.is_support);
  const resistDynamic=dynamic.filter(d=>!d.is_support);

  return `
    <div class="levels-section">
      <div class="detail-card-title">Entry Targets & Key Levels</div>
      ${poc?`<div style="margin-bottom:16px">${renderPOC()}</div>`:''}
      <div class="levels-grid">
        <div class="levels-column support">
          <h4>Support / Demand Zones (Long)</h4>
          ${supports.length>0?supports.map(s=>renderLevelItem(s,'support')).join(''):'<div class="no-levels">No support levels found</div>'}
          ${supportDynamic.map(d=>renderDynamic(d)).join('')}
        </div>
        <div class="levels-column resistance">
          <h4>Resistance / Supply Zones (Short)</h4>
          ${resistances.length>0?resistances.map(r=>renderLevelItem(r,'resistance')).join(''):'<div class="no-levels">No resistance levels found</div>'}
          ${resistDynamic.map(d=>renderDynamic(d)).join('')}
        </div>
      </div>
      ${levels.atr_pct?`<div style="margin-top:12px;font-size:11px;color:var(--text-secondary);text-align:center">ATR: ${levels.atr_pct}% ¬∑ Volatility-adjusted levels based on 200 1h candles</div>`:''}
    </div>
  `;
}

// Detail View Functions
function showDetail(sym){
  const coin=allCoins.find(c=>c.symbol===sym);
  if(!coin)return;

  detailState={symbol:sym,coin:coin,cursor:null,loading:false,history:[],historyLoaded:false};

  document.getElementById("list-view").classList.add("hidden");
  const dv=document.getElementById("detail-view");
  dv.classList.add("active");

  // Show shimmer loading first
  dv.innerHTML=renderDetailShimmer();

  // Then render actual content after brief delay for smooth transition
  setTimeout(()=>renderDetailView(coin),100);

  // Load history in background
  loadDetailHistory(sym);
}

function renderDetailShimmer(){
  return `
    <div class="detail-header">
      <button class="back-btn shimmer shimmer-block" style="width:40px;height:40px"></button>
      <div class="detail-title">
        <div class="shimmer shimmer-circle" style="width:48px;height:48px"></div>
        <div style="flex:1"><div class="shimmer shimmer-text" style="width:120px;height:22px;margin-bottom:6px"></div><div class="shimmer shimmer-text" style="width:80px;height:14px"></div></div>
      </div>
      <div><div class="shimmer shimmer-block" style="width:150px;height:32px;margin-bottom:6px"></div><div class="shimmer shimmer-block" style="width:80px;height:16px;margin-left:auto"></div></div>
    </div>
    <div class="detail-grid">
      <div class="detail-card"><div class="shimmer shimmer-text" style="width:100px;margin-bottom:20px"></div><div class="shimmer shimmer-block" style="width:100%;height:120px"></div></div>
      <div class="detail-card"><div class="shimmer shimmer-text" style="width:100px;margin-bottom:20px"></div><div class="shimmer shimmer-block" style="width:100%;height:120px"></div></div>
    </div>
    <div class="indicator-grid">
      ${[1,2,3,4].map(()=>'<div class="indicator-card"><div class="shimmer shimmer-text" style="width:60%;margin:0 auto 12px"></div><div class="shimmer shimmer-block" style="width:50%;height:24px;margin:0 auto"></div></div>').join('')}
    </div>
    <div class="signals-section"><div class="shimmer shimmer-text" style="width:80px;margin-bottom:16px"></div><div style="display:flex;gap:8px">${[1,2,3].map(()=>'<div class="shimmer shimmer-block" style="width:100px;height:32px"></div>').join('')}</div></div>
    <div class="history-section"><div class="shimmer shimmer-block" style="width:100%;height:300px"></div></div>
  `;
}

function renderDetailView(coin){
  const i=coin.indicators["1h"];
  const i4=coin.indicators["4h"]||{};
  const spotVol=coin.spot_volume||0;
  const futVol=coin.futures_volume||0;
  const totalVol=spotVol+futVol;
  const spotPct=totalVol>0?Math.round(spotVol/totalVol*100):50;
  const futPct=100-spotPct;

  const dv=document.getElementById("detail-view");
  dv.innerHTML=`
    <div class="detail-header">
      <button class="back-btn" onclick="hideDetail()">‚Üê</button>
      <div class="detail-title">
        <div class="detail-icon">${coin.display_name.slice(0,2)}</div>
        <div class="detail-name"><h2>${coin.display_name}</h2><span>${coin.symbol} ¬∑ Rank #${allCoins.indexOf(coin)+1}</span></div>
      </div>
      <div class="detail-price">
        <div class="detail-price-value">$${fmtPrice(coin.price)}</div>
        <div class="detail-price-change ${coin.price_change_24h>=0?'positive':'negative'}">${coin.price_change_24h>0?'+':''}${coin.price_change_24h}% (24h)</div>
      </div>
    </div>

    <div class="detail-grid">
      <div class="detail-card">
        <div class="detail-card-title">Volume Distribution</div>
        <div class="chart-container">
          <div class="pie-chart" style="background:conic-gradient(var(--blue) 0% ${spotPct}%, var(--orange) ${spotPct}% 100%)">
            <div class="pie-center">
              <div class="pie-center-value">$${fmtVol(totalVol)}</div>
              <div class="pie-center-label">Total</div>
            </div>
          </div>
          <div class="chart-legend">
            <div class="legend-row">
              <div class="legend-color" style="background:var(--blue)"></div>
              <span class="legend-label">Spot Volume</span>
              <span class="legend-value">$${fmtVol(spotVol)}</span>
              <span class="legend-pct">${spotPct}%</span>
            </div>
            <div class="legend-row">
              <div class="legend-color" style="background:var(--orange)"></div>
              <span class="legend-label">Futures Volume</span>
              <span class="legend-value">$${fmtVol(futVol)}</span>
              <span class="legend-pct">${futPct}%</span>
            </div>
            <div class="legend-row">
              <div class="legend-color" style="background:var(--text-secondary)"></div>
              <span class="legend-label">Spot Change</span>
              <span class="legend-value ${coin.spot_volume_change>=0?'positive':'negative'}">${coin.spot_volume_change>0?'+':''}${coin.spot_volume_change}%</span>
              <span class="legend-pct"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="detail-card">
        <div class="detail-card-title">Score Breakdown (${coin.score.grade} - ${coin.score.percentage}%)</div>
        <div class="score-breakdown">
          ${Object.entries(coin.score.component_scores).map(([k,v])=>`
            <div class="score-row">
              <span class="score-label">${k}</span>
              <div class="score-bar-container">
                <div class="score-bar" style="width:${v}%;background:${getScoreColor(v)}"></div>
              </div>
              <span class="score-value" style="color:${getScoreColor(v)}">${v}</span>
            </div>
          `).join('')}
        </div>
        <div class="weights-used">
          Weights: OBV ${coin.score.weights_used?.obv||50}% ¬∑ Volume ${coin.score.weights_used?.volume||50}%
          ${coin.score.confidence_modifier&&coin.score.confidence_modifier!==1?` ¬∑ Structure: ${coin.score.confidence_modifier>1?'+':''}${Math.round((coin.score.confidence_modifier-1)*100)}%`:''}
        </div>
        ${coin.score.structure_status&&coin.score.structure_status!=='neutral'?`
        <div class="structure-status ${coin.score.structure_status}">
          Structure ${coin.score.structure_status==='confirms'?'‚úì confirms':coin.score.structure_status==='conflicts'?'‚ö† conflicts with':coin.score.structure_status==='breakout'?'‚ö° BREAKOUT':'‚ö° BREAKDOWN'} signal
        </div>
        `:''}
        ${coin.score.warnings&&coin.score.warnings.length>0?`
        <div class="warnings-section">
          <div class="warnings-title">Warning Flags</div>
          <div class="warnings-list">
            ${coin.score.warnings.map(w=>`
              <div class="warning-item ${w.sentiment} ${w.level}">
                <span class="warning-type">${w.type.toUpperCase()}</span>
                <span class="warning-msg">${w.message}</span>
              </div>
            `).join('')}
          </div>
        </div>
        `:''}
      </div>
    </div>

    <div class="indicator-grid">
      <div class="indicator-card">
        <div class="indicator-label">Market Structure</div>
        <div class="indicator-value ${coin.structure?.structure==='bullish'?'positive':coin.structure?.structure==='bearish'?'negative':''}">${(coin.structure?.structure||'--').toUpperCase()}</div>
        <div class="indicator-sub">${coin.structure?.structure_break?'‚ö° '+coin.structure.structure_break.replace('_',' ').toUpperCase():(coin.structure?.confidence||'--')+' confidence'}</div>
      </div>
      <div class="indicator-card">
        <div class="indicator-label">OBV Trend</div>
        <div class="indicator-value ${i.obv_trend==='bullish'?'positive':i.obv_trend==='bearish'?'negative':''}">${(i.obv_trend||'--').toUpperCase()}</div>
        <div class="indicator-sub">${i.obv_strength||'--'} ¬∑ ${i.obv_change>0?'+':''}${i.obv_change?.toFixed(1)||0}%</div>
      </div>
      <div class="indicator-card">
        <div class="indicator-label">RSI (14)</div>
        <div class="indicator-value ${i.rsi<30?'positive':i.rsi>70?'negative':''}">${i.rsi?.toFixed(1)||'--'}</div>
        <div class="indicator-sub">${i.rsi<30?'Oversold':i.rsi>70?'Overbought':'Neutral'}</div>
      </div>
      <div class="indicator-card">
        <div class="indicator-label">Funding Rate</div>
        <div class="indicator-value ${coin.funding_rate>0.01?'negative':coin.funding_rate<-0.01?'positive':''}">${coin.funding_rate.toFixed(4)}%</div>
        <div class="indicator-sub">${coin.funding_rate>0.01?'Longs Paying':coin.funding_rate<-0.01?'Shorts Paying':'Neutral'}</div>
      </div>
    </div>

    ${coin.momentum?`
    <div class="momentum-box ${coin.momentum.sentiment}">
      <div class="momentum-header">
        <span class="momentum-icon">üìä</span>
        <span class="momentum-label">Trend Insight (24-48h Outlook)</span>
        <span class="momentum-confidence ${coin.momentum.confidence}">${coin.momentum.confidence.toUpperCase()}</span>
      </div>
      <div class="momentum-text">${coin.momentum.text}</div>
      <div class="momentum-bias">
        <span><span class="bias-dot ${coin.momentum.ltf_bias}"></span>Short-term (1h): <strong>${coin.momentum.ltf_bias.toUpperCase()}</strong></span>
        <span><span class="bias-dot ${coin.momentum.htf_bias}"></span>Macro (4h): <strong>${coin.momentum.htf_bias.toUpperCase()}</strong></span>
      </div>
    </div>
    `:''}

    <div class="signals-section">
      <div class="detail-card-title">Active Signals</div>
      <div class="signals-grid">
        ${coin.signals.map(s=>`<span class="signal-chip signal-tag ${sigClass(s)}">${s}</span>`).join('')}
        ${coin.signals.length===0||coin.signals[0]==='No signals'?'<span style="color:var(--text-secondary)">No active signals</span>':''}
      </div>
    </div>

    ${renderLevelsSection(coin)}

    <div class="history-section">
      <div class="history-header">
        <h3>Historical Performance</h3>
        <span style="color:var(--text-secondary);font-size:12px">Daily averages</span>
      </div>
      <div id="history-content">
        <div style="padding:40px;text-align:center">
          <div class="spinner" style="margin:0 auto 10px"></div>
          <div style="color:var(--text-secondary);font-size:13px">Loading history...</div>
        </div>
      </div>
    </div>
  `;
}

async function loadDetailHistory(sym){
  try{
    const hd=await(await fetch("/api/coin/"+encodeURIComponent(sym)+"/history?limit=30")).json();
    detailState.cursor=hd.next_cursor;
    detailState.history=hd.history||[];
    detailState.historyLoaded=true;
    renderHistoryTable(hd.today,detailState.history,hd.has_more);
  }catch(e){
    document.getElementById("history-content").innerHTML='<div class="no-history">Failed to load history</div>';
  }
}

function renderHistoryTable(today,hist,more){
  const el=document.getElementById("history-content");
  if(!el)return;

  if(!today&&hist.length===0){
    el.innerHTML='<div class="no-history">No historical data yet. Data will appear after the first full day of tracking.</div>';
    return;
  }

  let h='<table class="history-table"><thead><tr><th>Date</th><th>Avg Score</th><th>Price Change</th><th>Scans</th></tr></thead><tbody>';

  if(today){
    const oc=today.price_change_pct>=0?'positive':'negative';
    h+=`<tr><td>${fmtDate(today.date)}<span class="today-badge">TODAY</span></td><td><span class="history-grade ${scoreClass(today.avg_grade)}">${today.avg_grade}</span> <span style="color:var(--text-secondary)">(${today.avg_score}%)</span></td><td class="${oc}">${today.price_change_pct>=0?'+':''}${today.price_change_pct}%</td><td>${today.scan_count}</td></tr>`;
  }

  hist.forEach(d=>{
    const oc=d.price_change_pct>=0?'positive':'negative';
    h+=`<tr><td>${fmtDate(d.date)}</td><td><span class="history-grade ${scoreClass(d.avg_grade)}">${d.avg_grade}</span> <span style="color:var(--text-secondary)">(${d.avg_score}%)</span></td><td class="${oc}">${d.price_change_pct>=0?'+':''}${d.price_change_pct}%</td><td>${d.scan_count}</td></tr>`;
  });

  h+='</tbody></table>';
  if(more)h+='<div class="load-more-container"><button class="btn btn-secondary" onclick="loadMoreHistory()">Load More</button></div>';

  el.innerHTML=h;
}

async function loadMoreHistory(){
  if(detailState.loading||!detailState.cursor)return;
  detailState.loading=true;

  try{
    const d=await(await fetch("/api/coin/"+encodeURIComponent(detailState.symbol)+"/history?limit=30&before="+detailState.cursor)).json();
    detailState.cursor=d.next_cursor;
    detailState.history=[...detailState.history,...(d.history||[])];

    const td=await(await fetch("/api/coin/"+encodeURIComponent(detailState.symbol)+"/history?limit=1")).json();
    renderHistoryTable(td.today,detailState.history,d.has_more);
  }catch(e){console.error(e)}

  detailState.loading=false;
}

function refreshDetailData(){
  if(!detailState.symbol)return;
  const coin=allCoins.find(c=>c.symbol===detailState.symbol);
  if(coin){
    detailState.coin=coin;
    renderDetailView(coin);
    if(detailState.historyLoaded){
      loadDetailHistory(detailState.symbol);
    }
  }
}

function hideDetail(){
  detailState={symbol:null,coin:null,cursor:null,loading:false,history:[],historyLoaded:false};
  document.getElementById("detail-view").classList.remove("active");
  document.getElementById("detail-view").innerHTML='';
  document.getElementById("list-view").classList.remove("hidden");
}

// Add Coin Modal
let searchResults=[],searchTimeout=null;

async function openAddCoinModal(){
  document.getElementById("add-coin-modal").classList.add("active");
  const body=document.getElementById("add-coin-body");
  body.innerHTML='<div class="loading"><div class="spinner"></div>Loading...</div>';
  try{
    const r=await(await fetch("/api/coins/available")).json();
    allAvailable=r.coins||[];
    searchResults=[];
    renderAddCoin();
  }catch(e){body.innerHTML='<div class="empty-state">Error</div>'}
}

function renderAddCoin(){
  const body=document.getElementById("add-coin-body");
  let h='<div class="search-section" style="margin-bottom:16px"><div class="search-box" style="width:100%"><span>üîç</span><input type="text" id="coin-search-input" placeholder="Search any Binance pair..." oninput="handleCoinSearch(this.value)" style="width:100%"></div></div>';
  h+='<div id="search-results-container"></div>';
  h+='<div class="add-coin-section"><h3>Default Coins ('+allAvailable.length+')</h3><div class="add-coin-grid">'+
    allAvailable.map(c=>{
      const added=userCoins.includes(c);
      return '<button class="add-coin-btn'+(added?' added':'')+'" onclick="toggleCoin(\''+c+'\')">'+c.replace('/USDT','')+(added?' ‚úì':'')+'</button>';
    }).join('')+'</div></div>';
  body.innerHTML=h;
}

function handleCoinSearch(query){
  clearTimeout(searchTimeout);
  const container=document.getElementById("search-results-container");
  if(!query||query.length<1){container.innerHTML='';return}
  container.innerHTML='<div style="padding:10px;color:var(--text-secondary);font-size:12px">Searching...</div>';
  searchTimeout=setTimeout(async()=>{
    try{
      const r=await(await fetch("/api/coins/search?q="+encodeURIComponent(query))).json();
      searchResults=r.results||[];
      renderSearchResults();
    }catch(e){container.innerHTML='<div style="padding:10px;color:var(--red);font-size:12px">Search error</div>'}
  },300);
}

function renderSearchResults(){
  const container=document.getElementById("search-results-container");
  if(!searchResults.length){container.innerHTML='<div class="add-coin-section"><h3>No results found</h3></div>';return}
  container.innerHTML='<div class="add-coin-section"><h3>Search Results ('+searchResults.length+')</h3><div class="add-coin-grid">'+
    searchResults.map(c=>{
      const added=userCoins.includes(c.symbol);
      return '<button class="add-coin-btn'+(added?' added':'')+'" onclick="toggleCoin(\''+c.symbol+'\')">'+c.base+(added?' ‚úì':'')+'</button>';
    }).join('')+'</div></div>';
}

async function toggleCoin(sym){
  const added=userCoins.includes(sym);
  if(added){
    await fetch("/api/coins/remove",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({symbol:sym})});
    userCoins=userCoins.filter(c=>c!==sym);
  }else{
    const r=await fetch("/api/coins/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({symbol:sym})});
    const data=await r.json();
    if(data.error){alert(data.error);return}
    userCoins.push(sym);
  }
  const searchInput=document.getElementById("coin-search-input");
  const searchValue=searchInput?searchInput.value:'';
  renderAddCoin();
  if(searchValue){
    document.getElementById("coin-search-input").value=searchValue;
    renderSearchResults();
  }
  fetchData();
}

async function removeCoin(sym){
  await fetch("/api/coins/remove",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({symbol:sym})});
  userCoins=userCoins.filter(c=>c!==sym);
  fetchData();
}

function closeAddCoinModal(){document.getElementById("add-coin-modal").classList.remove("active")}

function toggleDropdown(){document.getElementById("user-dropdown").classList.toggle("show")}
document.addEventListener("click",e=>{if(!e.target.closest(".dropdown"))document.getElementById("user-dropdown").classList.remove("show")});
document.addEventListener("keydown",e=>{
  if(e.key==="Escape"){
    if(detailState.symbol)hideDetail();
    closeAddCoinModal();
  }
});
document.querySelectorAll(".modal").forEach(m=>m.addEventListener("click",e=>{if(e.target.classList.contains("modal"))closeAddCoinModal()}));

// === ALERT SYSTEM ===
let alertSettings = null;
let linkCode = null;

async function loadAlertSettings(){
  try {
    const res = await fetch('/api/alerts/settings');
    alertSettings = await res.json();
    updateAlertToggle();
  } catch(e) { console.error('Failed to load alert settings:', e); }
}

function updateAlertToggle(){
  const toggle = document.getElementById('alert-toggle');
  if(alertSettings && alertSettings.telegram_chat_id && alertSettings.alerts_enabled){
    toggle.classList.add('active');
  } else {
    toggle.classList.remove('active');
  }
}

async function openAlertModal(){
  await loadAlertSettings();
  renderAlertModal();
  document.getElementById('alert-modal').classList.add('show');
}

function closeAlertModal(){
  document.getElementById('alert-modal').classList.remove('show');
}

function renderAlertModal(){
  const modal = document.getElementById('alert-modal-body');
  const isLinked = alertSettings && alertSettings.telegram_chat_id;

  if(isLinked){
    modal.innerHTML = `
      <div class="alert-section">
        <div class="alert-section-title">Telegram Status</div>
        <div class="link-status linked">
          <div style="font-size:24px;margin-bottom:8px">‚úÖ</div>
          <div style="font-weight:600;margin-bottom:4px">Connected</div>
          <div style="font-size:11px;color:var(--text-secondary)">Alerts will be sent to your Telegram</div>
        </div>
        <button class="alert-btn secondary" onclick="testAlert()" style="margin-top:12px">Send Test Alert</button>
        <button class="alert-btn danger" onclick="unlinkTelegram()" style="margin-top:8px">Disconnect Telegram</button>
      </div>

      <div class="alert-section">
        <div class="alert-section-title">Alert Types</div>
        <div class="alert-option">
          <div class="alert-option-info">
            <div class="alert-option-title">Structure Breaks</div>
            <div class="alert-option-desc">When price breaks key structure levels</div>
          </div>
          <div class="toggle-switch ${alertSettings.alert_structure_break?'active':''}" onclick="toggleAlertOption('alert_structure_break',this)"></div>
        </div>
        <div class="alert-option">
          <div class="alert-option-info">
            <div class="alert-option-title">OBV Divergences</div>
            <div class="alert-option-desc">When OBV diverges from price action</div>
          </div>
          <div class="toggle-switch ${alertSettings.alert_divergence?'active':''}" onclick="toggleAlertOption('alert_divergence',this)"></div>
        </div>
        <div class="alert-option">
          <div class="alert-option-info">
            <div class="alert-option-title">High Confidence Signals</div>
            <div class="alert-option-desc">Strong momentum with confluence</div>
          </div>
          <div class="toggle-switch ${alertSettings.alert_high_confidence?'active':''}" onclick="toggleAlertOption('alert_high_confidence',this)"></div>
        </div>
        <div class="alert-option">
          <div class="alert-option-info">
            <div class="alert-option-title">RSI Extremes</div>
            <div class="alert-option-desc">When RSI is extremely overbought/oversold</div>
          </div>
          <div class="toggle-switch ${alertSettings.alert_rsi_extreme?'active':''}" onclick="toggleAlertOption('alert_rsi_extreme',this)"></div>
        </div>
      </div>

      <div class="alert-section">
        <div class="alert-section-title">Master Switch</div>
        <div class="alert-option">
          <div class="alert-option-info">
            <div class="alert-option-title">Alerts Enabled</div>
            <div class="alert-option-desc">Turn all alerts on or off</div>
          </div>
          <div class="toggle-switch ${alertSettings.alerts_enabled?'active':''}" onclick="toggleAlertOption('alerts_enabled',this)"></div>
        </div>
      </div>
    `;
  } else {
    modal.innerHTML = `
      <div class="alert-section">
        <div class="alert-section-title">Connect Telegram</div>
        <div class="link-status unlinked">
          <div style="font-size:24px;margin-bottom:8px">üì±</div>
          <div style="font-weight:600;margin-bottom:8px">Link Your Telegram</div>
          <div class="link-instructions">
            <ol>
              <li>Open Telegram and search for <code>@YourCryptoSignalsBot</code></li>
              <li>Start a chat with the bot</li>
              <li>Click the button below to get your code</li>
              <li>Send the code to the bot</li>
            </ol>
          </div>
        </div>
        <button class="alert-btn primary" onclick="generateLinkCode()" id="get-code-btn">Get Link Code</button>
        <div id="link-code-display" style="display:none;margin-top:16px;text-align:center">
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Send this code to the bot:</div>
          <div class="link-code" id="link-code-value"></div>
          <div style="font-size:11px;color:var(--text-secondary)">Code expires in 30 minutes</div>
        </div>
      </div>
    `;
  }
}

async function generateLinkCode(){
  const btn = document.getElementById('get-code-btn');
  btn.disabled = true;
  btn.textContent = 'Generating...';

  try {
    const res = await fetch('/api/alerts/link', {method:'POST'});
    const data = await res.json();
    linkCode = data.code;

    document.getElementById('link-code-value').textContent = linkCode;
    document.getElementById('link-code-display').style.display = 'block';
    btn.textContent = 'Code Generated';
  } catch(e) {
    btn.disabled = false;
    btn.textContent = 'Get Link Code';
    alert('Failed to generate code');
  }
}

async function toggleAlertOption(option, el){
  const newValue = !el.classList.contains('active');
  el.classList.toggle('active');

  try {
    await fetch('/api/alerts/settings', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({[option]: newValue ? 1 : 0})
    });
    alertSettings[option] = newValue ? 1 : 0;
    updateAlertToggle();
  } catch(e) {
    el.classList.toggle('active'); // Revert
    alert('Failed to update setting');
  }
}

async function testAlert(){
  try {
    const res = await fetch('/api/alerts/test', {method:'POST'});
    const data = await res.json();
    if(data.status === 'sent'){
      alert('Test alert sent! Check your Telegram.');
    } else {
      alert('Failed to send test alert.');
    }
  } catch(e) { alert('Failed to send test alert.'); }
}

async function unlinkTelegram(){
  if(!confirm('Are you sure you want to disconnect Telegram?')) return;

  try {
    await fetch('/api/alerts/unlink', {method:'POST'});
    alertSettings.telegram_chat_id = null;
    alertSettings.alerts_enabled = 0;
    renderAlertModal();
    updateAlertToggle();
  } catch(e) { alert('Failed to unlink Telegram.'); }
}

// Load alert settings on page load
loadAlertSettings();

// === SIDEBAR COLLAPSE ===
function toggleSidebar(){
  const main = document.getElementById('main-container');
  main.classList.toggle('collapsed');
  localStorage.setItem('sidebarCollapsed', main.classList.contains('collapsed') ? '1' : '0');
}

// Restore sidebar state on load
if(localStorage.getItem('sidebarCollapsed') === '1'){
  document.getElementById('main-container').classList.add('collapsed');
}

// Close alert modal on backdrop click
document.getElementById('alert-modal').addEventListener('click', e => {
  if(e.target.id === 'alert-modal') closeAlertModal();
});
</script>

<!-- Alert Modal -->
<div class="alert-modal" id="alert-modal">
  <div class="alert-modal-content">
    <div class="alert-modal-header">
      <h3>üîî Alert Settings</h3>
      <button class="alert-modal-close" onclick="closeAlertModal()">&times;</button>
    </div>
    <div class="alert-modal-body" id="alert-modal-body">
      Loading...
    </div>
  </div>
</div>
</body>
</html>
